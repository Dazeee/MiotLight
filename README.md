# MiotLight

基于esp-01s单片机和sg90舵机的小爱同学智能灯的实现代码，支持普通开关与单刀双掷开关

代码修改自B站up主 [@无聊的改造](https://space.bilibili.com/673389059) 对应视频 [esp-01s单片机舵机开关灯教程支持小爱控制1/3](https://www.bilibili.com/video/BV1m3411J7jZ) 系列的分享，感谢up的无私分享！

针对原代码做了如下优化&升级

1. 修改设备注册方式，原本是注册设备类型为“插座”，修改后注册为“灯”
2. 优化了问题：开关灯时，操作舵机后，回复操作完成的请求发送过慢，导致小爱频繁反馈“设备出错了”（实现方式：先反馈操作完成，再操作舵机+睡眠）
3. 新增了自用的单刀双掷开关的代码（好用自取，不好用勿喷……因为没办法做到检测灯光、开关状态）
   * 原理：不管喊开灯还是关灯，都让设备按与上一次操作不同的按键
   * 使用方式：舵机操控的灯的开关，不能手动按，否则开关灯的操作不准。自己通过眼睛看看灯开了没，没开就喊开灯，开了就喊关灯
   * 初始化/开关校正方式：喊两次指令。比如我喊开灯，舵机旋转后没有按到开关，就再喊一次开灯，此后开灯关灯都匹配了
4. 初始化了舵机的角度，避免断电后开关机无法操作的问题。（建议通过修改安装舵机的浆片，让浆片初始处于中间位置，SG90是可以很方便拆卸浆片、重新用不同角度安装的。如果开关灯的操作反了，可对调修改ran_max1、ran_min1两个变量的初始值，再重新烧录单片机代码）



## 一拖二

新增了一个eps-01s单片机控制两个舵机的代码  在ControlTwoLight.ino文件

部署要点

1. 舵机1的数据线连接IO0，舵机2的数据线连接IO2。注意单片机和舵机要共地，即单片机的GND要连接舵机1、舵机2的负极
   * 我的做法是，GND用两根线连舵机1负极，两根线中间的部分引一根线去连舵机2的负极
2. 两个舵机的角度不好控制，建议基于三个滑块方法 slider1_callback、slider2_callback、slider3_callback 分别调试好两个舵机的角度后，在代码写死两个舵机的角度
   * 我的做法，先让滑块方法只控制舵机1调试好角度，再重新改代码、烧录代码让滑块方法只控制舵机2来调整角度。最好有多一个烧录器，部署好开关灯的舵机之后，直接留下烧录器，把单片机取下插在另一个烧录器上，插电脑上烧录代码
